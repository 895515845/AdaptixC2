name: Build AdaptixClient

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create a GitHub Release'
        required: false
        default: 'true'

permissions:
  contents: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            os_name: linux
            cmake_gen: "Unix Makefiles"
          - os: macos-latest
            os_name: macos
            cmake_gen: "Unix Makefiles"
          - os: windows-latest
            os_name: windows
            cmake_gen: "MinGW Makefiles"

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          path: AdaptixC2
          ref: ${{ github.ref }}

      # ğŸ§ Linux ä¾èµ–ä¿®å¤: å¢åŠ äº† qt6-declarative-dev (ç”¨äºQML)
      - name: Install dependencies (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake qt6-base-dev qt6-websockets-dev qt6-tools-dev libgl1-mesa-dev qt6-declarative-dev

      # ğŸ/ğŸªŸ å®‰è£… Qt: å¢åŠ äº† tools: 'tools_mingw' ä»¥è·å–æ­£ç¡®çš„ç¼–è¯‘å™¨
      - name: Install Qt (macOS/Windows)
        if: runner.os != 'Linux'
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.5.3'
          host: ${{ matrix.os_name == 'windows' && 'windows' || 'mac' }}
          target: 'desktop'
          arch: ${{ matrix.os_name == 'windows' && 'win64_mingw' || 'clang_64' }}
          dir: '${{ github.workspace }}/qt/'
          install-deps: 'true'
          modules: 'qtwebsockets'
          # å…³é”®ä¿®æ­£ï¼šæ˜¾å¼å®‰è£… MinGW å·¥å…·é“¾ï¼Œé˜²æ­¢ä½¿ç”¨ç³»ç»Ÿè‡ªå¸¦çš„æ—§ç‰ˆ GCC
          tools: 'tools_mingw' 

      # ğŸªŸ Windows ç¼–è¯‘å™¨è·¯å¾„ä¿®æ­£
      # æˆ‘ä»¬ä¸æ‰‹åŠ¨åŠ  PATHï¼Œè€Œæ˜¯ç›´æ¥æ£€æŸ¥ verifyï¼Œinstall-qt-action ä¼šè‡ªåŠ¨å¤„ç†å¥½ç¯å¢ƒ
      - name: Check Compiler (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          gcc --version
          g++ --version
          where gcc
          where mingw32-make

      - name: Configure CMake
        shell: bash
        run: |
          cd AdaptixC2/AdaptixClient
          
          # Windows ä¸‹å¼ºåˆ¶æŒ‡å®š CMake å‚æ•°ï¼Œé˜²æ­¢å®ƒå»æ‰¾ C:/mingw64
          if [ "${{ matrix.os_name }}" == "windows" ]; then
             cmake -B build -G "${{ matrix.cmake_gen }}" \
                   -DCMAKE_BUILD_TYPE=Release \
                   -DCMAKE_C_COMPILER=gcc \
                   -DCMAKE_CXX_COMPILER=g++ \
                   -DCMAKE_MAKE_PROGRAM=mingw32-make
          else
             cmake -B build -G "${{ matrix.cmake_gen }}" -DCMAKE_BUILD_TYPE=Release
          fi

      - name: Build AdaptixClient
        run: |
          cd AdaptixC2/AdaptixClient
          cmake --build build --config Release --parallel

      # ğŸ“¦ æ‰“åŒ…é€»è¾‘ (Unix)
      - name: Prepare release package (Unix)
        if: runner.os != 'Windows'
        run: |
          cd AdaptixC2/AdaptixClient
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
          else
            VERSION="latest"
          fi
          
          mkdir -p release-package
          # macOS å…¼å®¹æ€§å¤„ç†
          if [ "${{ matrix.os_name }}" == "macos" ]; then
             # å°è¯•æ‹·è´ .app æˆ–è€…äºŒè¿›åˆ¶æ–‡ä»¶
             if [ -d "build/AdaptixClient.app" ]; then
                 cp -r build/AdaptixClient.app release-package/
             else
                 cp build/AdaptixClient release-package/ 2>/dev/null || true
             fi
          else
             cp build/AdaptixClient release-package/ 2>/dev/null || true
          fi
          
          tar -czf AdaptixClient-${{ matrix.os_name }}-${VERSION}.tar.gz -C release-package .
          zip -r AdaptixClient-${{ matrix.os_name }}-${VERSION}.zip release-package/*

      # ğŸ“¦ æ‰“åŒ…é€»è¾‘ (Windows)
      - name: Prepare release package (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          cd AdaptixC2/AdaptixClient
          $VERSION = "latest"
          if ("${{ github.ref }}" -match "refs/tags/") {
            $VERSION = "${{ github.ref }}" -replace "refs/tags/", ""
          }
          
          New-Item -ItemType Directory -Force -Path release-package
          
          $exePath = "build/AdaptixClient.exe"
          if (-not (Test-Path $exePath)) { $exePath = "build/Release/AdaptixClient.exe" }
          
          if (Test-Path $exePath) {
            Copy-Item $exePath "release-package/"
            # è‡ªåŠ¨éƒ¨ç½² Qt ä¾èµ– DLL
            windeployqt --release --no-translations --no-system-d3d-compiler "release-package/AdaptixClient.exe"
            Compress-Archive -Path "release-package/*" -DestinationPath "AdaptixClient-windows-${VERSION}.zip"
          } else {
            Write-Warning "AdaptixClient.exe not found, skipping packaging."
          }

      - name: Upload release archives
        uses: actions/upload-artifact@v4
        with:
          name: release-archives-${{ matrix.os_name }}
          path: |
            AdaptixC2/AdaptixClient/*.tar.gz
            AdaptixC2/AdaptixClient/*.zip
          if-no-files-found: warn

  create-release:
    needs: build
    if: startsWith(github.ref, 'refs/tags/v') || (github.event_name == 'workflow_dispatch' && github.event.inputs.create_release == 'true')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: release-archives-*
          merge-multiple: true

      - name: Prepare release files
        run: |
          mkdir -p release_final
          cp artifacts/* release_final/
          
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
          else
            VERSION="latest"
          fi
          echo "VERSION=${VERSION}" >> $GITHUB_ENV

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: release_final/*
          tag_name: ${{ env.VERSION }}
          name: AdaptixClient Release ${{ env.VERSION }}
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ## AdaptixClient Release ${{ env.VERSION }}
            
            ### ğŸ“¥ ä¸‹è½½
            | å¹³å° | æ–‡ä»¶ |
            |---|---|
            | ğŸ§ Linux | `AdaptixClient-linux-${{ env.VERSION }}.tar.gz` |
            | ğŸ macOS | `AdaptixClient-macos-${{ env.VERSION }}.zip` |
            | ğŸªŸ Windows | `AdaptixClient-windows-${{ env.VERSION }}.zip` |
            
            âš ï¸ **æ³¨æ„**ï¼š
            - Windows ç‰ˆè§£å‹å³ç”¨ã€‚
            - Linux ç‰ˆéœ€å®‰è£… Qt6 åº“ã€‚
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
