name: Build AdaptixClient

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create a GitHub Release'
        required: false
        default: 'true'

# ğŸŸ¢ å¿…é¡»æ·»åŠ å†™æƒé™ï¼Œå¦åˆ™æ— æ³•å‘å¸ƒ Release
permissions:
  contents: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            os_name: linux
            cmake_gen: "Unix Makefiles"
          - os: macos-latest
            os_name: macos
            cmake_gen: "Unix Makefiles"
          - os: windows-latest
            os_name: windows
            cmake_gen: "MinGW Makefiles"

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          path: AdaptixC2
          ref: ${{ github.ref }}

      # ğŸ§ Linux ä¾èµ–å®‰è£… (ä¿æŒ aptï¼Œå› ä¸ºç³»ç»Ÿé›†æˆè¾ƒå¥½)
      - name: Install dependencies (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake qt6-base-dev qt6-websockets-dev qt6-tools-dev libgl1-mesa-dev

      # ğŸ macOS & ğŸªŸ Windows ä½¿ç”¨ä¸“ç”¨æ’ä»¶å®‰è£… Qt
      # è¿™æ˜¯æœ€ç¨³å¦¥çš„æ–¹æ³•ï¼Œç¡®ä¿ Windows ä¸‹æ‹¿åˆ° MinGW ç‰ˆæœ¬çš„ Qt
      - name: Install Qt (macOS/Windows)
        if: runner.os != 'Linux'
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.5.3' # ä½¿ç”¨ä¸€ä¸ªç¨³å®šçš„ LTS ç‰ˆæœ¬
          host: ${{ matrix.os_name == 'windows' && 'windows' || 'mac' }}
          target: 'desktop'
          arch: ${{ matrix.os_name == 'windows' && 'win64_mingw' || 'clang_64' }}
          dir: '${{ github.workspace }}/qt/'
          install-deps: 'true'
          modules: 'qtwebsockets' 

      # ä¿®æ­£ Windows ç¯å¢ƒå˜é‡ï¼Œç¡®ä¿èƒ½æ‰¾åˆ° MinGW
      - name: Setup MinGW (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          echo "C:\ProgramData\chocolatey\lib\mingw\tools\install\mingw64\bin" >> $env:GITHUB_PATH

      - name: Configure CMake
        run: |
          cd AdaptixC2/AdaptixClient
          cmake -B build -G "${{ matrix.cmake_gen }}" -DCMAKE_BUILD_TYPE=Release

      - name: Build AdaptixClient
        run: |
          cd AdaptixC2/AdaptixClient
          cmake --build build --config Release --parallel

      # ğŸ“¦ æ‰“åŒ…é€»è¾‘ (Unix)
      - name: Prepare release package (Unix)
        if: runner.os != 'Windows'
        run: |
          cd AdaptixC2/AdaptixClient
          # ç‰ˆæœ¬å·é€»è¾‘ç»Ÿä¸€
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
          else
            VERSION="latest"
          fi
          
          mkdir -p release-package
          # æŸ¥æ‰¾æ„å»ºäº§ç‰©ï¼ŒmacOS å¯èƒ½æ˜¯ .app ç›®å½•
          if [ "${{ matrix.os_name }}" == "macos" ]; then
             # macOS é€šå¸¸ç”Ÿæˆ Bundleï¼Œæˆ‘ä»¬éœ€è¦é‡Œé¢çš„å¯æ‰§è¡Œæ–‡ä»¶æˆ–è€…æ•´ä¸ª .app
             # è¿™é‡Œå‡è®¾æˆ‘ä»¬åªå–äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæˆ–è€…ä½ å¯ä»¥æ”¹ä¸ºæ‰“åŒ… .app
             cp -r build/AdaptixClient.app/Contents/MacOS/AdaptixClient release-package/ 2>/dev/null || cp build/AdaptixClient release-package/
          else
             cp build/AdaptixClient release-package/
          fi
          
          tar -czf AdaptixClient-${{ matrix.os_name }}-${VERSION}.tar.gz -C release-package .
          zip -r AdaptixClient-${{ matrix.os_name }}-${VERSION}.zip release-package/*

      # ğŸ“¦ æ‰“åŒ…é€»è¾‘ (Windows)
      - name: Prepare release package (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          cd AdaptixC2/AdaptixClient
          $VERSION = "latest"
          if ("${{ github.ref }}" -match "refs/tags/") {
            $VERSION = "${{ github.ref }}" -replace "refs/tags/", ""
          }
          
          New-Item -ItemType Directory -Force -Path release-package
          
          # å°è¯•æŸ¥æ‰¾ exe
          $exePath = "build/AdaptixClient.exe"
          if (-not (Test-Path $exePath)) { $exePath = "build/Release/AdaptixClient.exe" }
          
          if (Test-Path $exePath) {
            Copy-Item $exePath "release-package/"
            # Windows ä¸‹é€šå¸¸éœ€è¦æ‰“åŒ… Qt çš„ DLLï¼Œè¿™é‡Œä½¿ç”¨ windeployqt è‡ªåŠ¨æ‹·è´ä¾èµ–
            # æ³¨æ„ï¼šinstall-qt-action ä¼šè‡ªåŠ¨é…ç½®å¥½ path
            windeployqt --release --no-translations --no-system-d3d-compiler "release-package/AdaptixClient.exe"
            
            Compress-Archive -Path "release-package/*" -DestinationPath "AdaptixClient-windows-${VERSION}.zip"
          } else {
            Write-Error "Could not find AdaptixClient.exe"
          }

      - name: Upload release archives
        uses: actions/upload-artifact@v4
        with:
          name: release-archives-${{ matrix.os_name }}
          path: |
            AdaptixC2/AdaptixClient/*.tar.gz
            AdaptixC2/AdaptixClient/*.zip
          if-no-files-found: warn

  create-release:
    needs: build
    # é€»è¾‘ä¿®æ­£ï¼šTag è§¦å‘ æˆ– (æ‰‹åŠ¨è§¦å‘ ä¸” å‹¾é€‰å‘å¸ƒ)
    if: startsWith(github.ref, 'refs/tags/v') || (github.event_name == 'workflow_dispatch' && github.event.inputs.create_release == 'true')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: release-archives-*
          merge-multiple: true

      - name: Prepare release files
        run: |
          mkdir -p release_final
          cp artifacts/* release_final/
          ls -la release_final/
          
          # è®¾ç½®ç‰ˆæœ¬å·ç”¨äº Tag
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
          else
            VERSION="latest"
          fi
          echo "VERSION=${VERSION}" >> $GITHUB_ENV

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: release_final/*
          # ğŸŸ¢ ä¿®æ­£ï¼šæ˜¾å¼æŒ‡å®š Tagï¼Œé˜²æ­¢æ‰‹åŠ¨å‘å¸ƒæŠ¥é”™
          tag_name: ${{ env.VERSION }}
          name: AdaptixClient Release ${{ env.VERSION }}
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ## AdaptixClient Release ${{ env.VERSION }}
            
            ### ğŸ“¥ ä¸‹è½½åˆ—è¡¨
            | å¹³å° | æ–‡ä»¶å | è¯´æ˜ |
            |---|---|---|
            | ğŸ§ Linux | `AdaptixClient-linux-${{ env.VERSION }}.tar.gz` | tar.gz å‹ç¼©åŒ… |
            | ğŸ§ Linux | `AdaptixClient-linux-${{ env.VERSION }}.zip` | zip å‹ç¼©åŒ… |
            | ğŸ macOS | `AdaptixClient-macos-${{ env.VERSION }}.tar.gz` | Intel/M1 é€šç”¨ |
            | ğŸªŸ Windows | `AdaptixClient-windows-${{ env.VERSION }}.zip` | åŒ…å«å®Œæ•´ä¾èµ– |
            
            ### âš ï¸ æ³¨æ„äº‹é¡¹
            - **Windows ç”¨æˆ·**: è§£å‹åç›´æ¥è¿è¡Œ `AdaptixClient.exe` å³å¯ï¼ˆä¾èµ–å·²æ‰“åŒ…ï¼‰ã€‚
            - **Linux ç”¨æˆ·**: è¯·ç¡®ä¿ç³»ç»Ÿå·²å®‰è£… Qt6 åŸºç¡€åº“ï¼Œæˆ–è€…ä½¿ç”¨ LD_LIBRARY_PATH æŒ‡å®šåº“è·¯å¾„ã€‚
            - **macOS ç”¨æˆ·**: å¦‚æœæç¤ºæ–‡ä»¶æŸåï¼Œè¯·æ‰§è¡Œ `xattr -cr AdaptixClient`ã€‚
            
            ### æ ¡éªŒå’Œ
            æ„å»º SHA: ${{ github.sha }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
