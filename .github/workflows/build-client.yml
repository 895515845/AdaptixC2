name: Build AdaptixClient (Linux Only)

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
    paths:
      - 'AdaptixClient/**'
      - '.github/workflows/build-client.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'AdaptixClient/**'
      - '.github/workflows/build-client.yml'
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create a GitHub Release'
        required: false
        default: 'true'

permissions:
  contents: write

jobs:
  build-linux:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          path: AdaptixC2
          ref: ${{ github.ref }}

      # 1. æ¸…ç†çŽ¯å¢ƒå¹¶å®‰è£…åº•å±‚ä¾èµ–
      # âš ï¸ å…³é”®ï¼šå¸è½½ç³»ç»Ÿè‡ªå¸¦çš„ Qt6 (ç‰ˆæœ¬é€šå¸¸æ˜¯ 6.4ï¼Œä¸æ”¯æŒ setColorScheme)ï¼Œé˜²æ­¢ CMake æ‰¾é”™
      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get remove -y qt6-base-dev qt6-base-private-dev libqt6* || true
          sudo apt-get autoremove -y
          
          # å®‰è£… Qt è¿è¡Œéœ€è¦çš„åº•å±‚åº“ (X11, OpenGL, XKB ç­‰)
          sudo apt-get install -y \
            build-essential git cmake libssl-dev libgl1-mesa-dev \
            libxkbcommon-dev libxkbcommon-x11-dev \
            libxcb-xkb-dev libxcb-icccm4-dev libxcb-image0-dev \
            libxcb-keysyms1-dev libxcb-randr0-dev libxcb-render-util0-dev \
            libxcb-render0-dev libxcb-shape0-dev libxcb-sync-dev \
            libxcb-xfixes0-dev libxcb-xinerama0-dev libxcb-xkb-dev \
            x11-xserver-utils python3-pip

      # 2. æ‰‹åŠ¨å®‰è£… Qt 6.7.2
      # ðŸŸ¢ æ”¹ç”¨ 6.7.2ï¼Œè¿™ä¸ªç‰ˆæœ¬éžå¸¸ç¨³å®šï¼Œä¸”æ”¯æŒ setColorScheme (6.5+å³å¯)
      - name: Install Qt 6.7.2 (Manual)
        run: |
          pip3 install aqtinstall --break-system-packages
          
          mkdir -p ${{ github.workspace }}/qt
          
          # ä¸‹è½½ Qt 6.7.2 (Linux Desktop gcc_64)
          python3 -m aqt install-qt linux desktop 6.7.2 gcc_64 \
            --outputdir ${{ github.workspace }}/qt \
            --modules qtwebsockets
          
          # è®¾ç½®çŽ¯å¢ƒå˜é‡
          QT_PATH=${{ github.workspace }}/qt/6.7.2/gcc_64
          echo "Qt6_DIR=$QT_PATH" >> $GITHUB_ENV
          echo "QT_PLUGIN_PATH=$QT_PATH/plugins" >>
