name: Build AdaptixClient

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create a GitHub Release'
        required: false
        default: 'true'

permissions:
  contents: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            os_name: linux
            cmake_gen: "Unix Makefiles"
          - os: macos-latest
            os_name: macos
            cmake_gen: "Unix Makefiles"
          - os: windows-latest
            os_name: windows
            cmake_gen: "MinGW Makefiles"

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          path: AdaptixC2
          ref: ${{ github.ref }}

      # ğŸ§ Linux: è¡¥å……ç¼ºå¤±çš„ XKB å’Œ X11 ä¾èµ–
      - name: Install dependencies (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake qt6-base-dev qt6-websockets-dev qt6-tools-dev libgl1-mesa-dev libxkbcommon-dev libxkbcommon-x11-dev libxcb-xkb-dev libxcb-icccm4-dev libxcb-image0-dev libxcb-keysyms1-dev libxcb-randr0-dev libxcb-render-util0-dev libxcb-render0-dev libxcb-shape0-dev libxcb-sync-dev libxcb-xfixes0-dev libxcb-xinerama0-dev libxcb-xkb-dev x11-xserver-utils

      # ğŸ macOS: ä»…å®‰è£… Qt åŸºç¡€åº“ï¼Œä¸è¯·æ±‚ MinGW
      - name: Install Qt (macOS)
        if: matrix.os == 'macos-latest'
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.5.3'
          host: 'mac'
          target: 'desktop'
          arch: 'clang_64'
          dir: '${{ github.workspace }}/qt/'
          install-deps: 'true'
          modules: 'qtwebsockets'

      # ğŸªŸ Windows: å¿…é¡»è¯·æ±‚ MinGW å·¥å…·é“¾
      - name: Install Qt (Windows)
        if: matrix.os == 'windows-latest'
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.5.3'
          host: 'windows'
          target: 'desktop'
          arch: 'win64_mingw'
          dir: '${{ github.workspace }}/qt/'
          install-deps: 'true'
          modules: 'qtwebsockets'
          tools: 'tools_mingw' # ğŸ‘ˆ ä»…åœ¨ Windows å¯ç”¨è¿™ä¸ª

      # ğŸªŸ Windows: å…³é”®ä¿®æ­£ - æŸ¥æ‰¾æ­£ç¡®çš„ Qt ç¼–è¯‘å™¨å¹¶æ¸…ç† PATH
      - name: Setup Windows Environment
        if: matrix.os == 'windows-latest'
        id: win_env
        shell: pwsh
        run: |
          # 1. æ‰¾åˆ° Qt å®‰è£…çš„ MinGW è·¯å¾„ (é€šå¸¸åœ¨ Tools ç›®å½•ä¸‹)
          $qtToolsPath = Get-ChildItem -Path "${{ github.workspace }}\qt\Tools" -Filter "mingw*" -Directory | Select-Object -First 1
          if (-not $qtToolsPath) { throw "Could not find Qt MinGW tools" }
          $mingwBin = Join-Path $qtToolsPath.FullName "bin"
          
          echo "Found Qt MinGW at: $mingwBin"
          
          # 2. å°†æ­£ç¡®çš„è·¯å¾„åŠ å…¥ GITHUB_ENV ä¾›åç»­ä½¿ç”¨
          echo "QT_MINGW_BIN=$mingwBin" >> $env:GITHUB_ENV
          
          # 3. å°†å…¶åŠ åˆ° PATH æœ€å‰é¢
          echo "$mingwBin" >> $env:GITHUB_PATH
          
          # 4. å½»åº•å±è”½ç³»ç»Ÿè‡ªå¸¦çš„ MinGW (è¿™æ˜¯æœ€å…³é”®çš„ä¸€æ­¥)
          # æˆ‘ä»¬æŠŠ C:\mingw64 é‡å‘½åï¼Œç¡®ä¿ CMake ç»å¯¹æ‰¾ä¸åˆ°å®ƒ
          if (Test-Path "C:\mingw64") {
            Rename-Item -Path "C:\mingw64" -NewName "C:\mingw64_backup"
            echo "Disabled system MinGW at C:\mingw64"
          }

      - name: Configure CMake
        shell: bash
        run: |
          cd AdaptixC2/AdaptixClient
          
          if [ "${{ matrix.os_name }}" == "windows" ]; then
             # æ˜¾å¼æŒ‡å®šç¼–è¯‘å™¨è·¯å¾„ï¼ŒåŒé‡ä¿é™©
             cmake -B build -G "${{ matrix.cmake_gen }}" \
                   -DCMAKE_BUILD_TYPE=Release \
                   -DCMAKE_C_COMPILER="$QT_MINGW_BIN/gcc.exe" \
                   -DCMAKE_CXX_COMPILER="$QT_MINGW_BIN/g++.exe" \
                   -DCMAKE_MAKE_PROGRAM="$QT_MINGW_BIN/mingw32-make.exe"
          else
             cmake -B build -G "${{ matrix.cmake_gen }}" -DCMAKE_BUILD_TYPE=Release
          fi

      - name: Build AdaptixClient
        run: |
          cd AdaptixC2/AdaptixClient
          cmake --build build --config Release --parallel

      # ğŸ“¦ æ‰“åŒ…é€»è¾‘ (Unix)
      - name: Prepare release package (Unix)
        if: runner.os != 'Windows'
        run: |
          cd AdaptixC2/AdaptixClient
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
          else
            VERSION="latest"
          fi
          
          mkdir -p release-package
          # macOS å…¼å®¹æ€§å¤„ç†
          if [ "${{ matrix.os_name }}" == "macos" ]; then
             if [ -d "build/AdaptixClient.app" ]; then
                 # å¦‚æœç”Ÿæˆçš„æ˜¯ .app åŒ…ï¼Œæˆ‘ä»¬åªå–é‡Œé¢çš„äºŒè¿›åˆ¶ï¼Œæˆ–è€…ä½ å¯ä»¥æ”¹ä¸ºæ‰“åŒ…æ•´ä¸ª .app
                 # ä¸ºäº†è·¨å¹³å°ç»Ÿä¸€ï¼Œè¿™é‡Œå°è¯•å–äºŒè¿›åˆ¶
                 cp -r build/AdaptixClient.app/Contents/MacOS/AdaptixClient release-package/ 2>/dev/null || cp -r build/AdaptixClient.app release-package/
             else
                 cp build/AdaptixClient release-package/ 2>/dev/null || true
             fi
          else
             cp build/AdaptixClient release-package/ 2>/dev/null || true
          fi
          
          tar -czf AdaptixClient-${{ matrix.os_name }}-${VERSION}.tar.gz -C release-package .
          zip -r AdaptixClient-${{ matrix.os_name }}-${VERSION}.zip release-package/*

      # ğŸ“¦ æ‰“åŒ…é€»è¾‘ (Windows)
      - name: Prepare release package (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          cd AdaptixC2/AdaptixClient
          $VERSION = "latest"
          if ("${{ github.ref }}" -match "refs/tags/") {
            $VERSION = "${{ github.ref }}" -replace "refs/tags/", ""
          }
          
          New-Item -ItemType Directory -Force -Path release-package
          
          $exePath = "build/AdaptixClient.exe"
          if (-not (Test-Path $exePath)) { $exePath = "build/Release/AdaptixClient.exe" }
          
          if (Test-Path $exePath) {
            Copy-Item $exePath "release-package/"
            # å…³é”®ï¼šéƒ¨ç½²ä¾èµ–æ—¶éœ€è¦æ˜¾å¼æŒ‡æ˜ bin ç›®å½•ï¼Œå¦åˆ™ windeployqt å¯èƒ½ä¼šå»ç³»ç»Ÿç›®å½•æ‰¾
            $env:PATH = "$env:QT_MINGW_BIN;" + $env:PATH
            windeployqt --release --no-translations --no-system-d3d-compiler "release-package/AdaptixClient.exe"
            
            Compress-Archive -Path "release-package/*" -DestinationPath "AdaptixClient-windows-${VERSION}.zip"
          } else {
            Write-Warning "AdaptixClient.exe not found, skipping packaging."
          }

      - name: Upload release archives
        uses: actions/upload-artifact@v4
        with:
          name: release-archives-${{ matrix.os_name }}
          path: |
            AdaptixC2/AdaptixClient/*.tar.gz
            AdaptixC2/AdaptixClient/*.zip
          if-no-files-found: warn

  create-release:
    needs: build
    if: startsWith(github.ref, 'refs/tags/v') || (github.event_name == 'workflow_dispatch' && github.event.inputs.create_release == 'true')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: release-archives-*
          merge-multiple: true

      - name: Prepare release files
        run: |
          mkdir -p release_final
          cp artifacts/* release_final/
          
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
          else
            VERSION="latest"
          fi
          echo "VERSION=${VERSION}" >> $GITHUB_ENV

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: release_final/*
          tag_name: ${{ env.VERSION }}
          name: AdaptixClient Release ${{ env.VERSION }}
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ## AdaptixClient Release ${{ env.VERSION }}
            
            ### ğŸ“¥ ä¸‹è½½
            | å¹³å° | æ–‡ä»¶ |
            |---|---|
            | ğŸ§ Linux | `AdaptixClient-linux-${{ env.VERSION }}.tar.gz` |
            | ğŸ macOS | `AdaptixClient-macos-${{ env.VERSION }}.zip` |
            | ğŸªŸ Windows | `AdaptixClient-windows-${{ env.VERSION }}.zip` |
            
            âš ï¸ **æ³¨æ„**ï¼š
            - Windows ç‰ˆè§£å‹å³ç”¨ã€‚
            - Linux ç‰ˆéœ€å®‰è£… Qt6 åº“ã€‚
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
