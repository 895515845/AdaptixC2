name: Build AdaptixClient

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
    paths:
      - 'AdaptixClient/**'
      - '.github/workflows/build-client.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'AdaptixClient/**'
      - '.github/workflows/build-client.yml'
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create a GitHub Release'
        required: false
        default: 'true'

permissions:
  contents: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            os_name: linux
            cmake_gen: "Unix Makefiles"
          - os: windows-latest
            os_name: windows
            cmake_gen: "MinGW Makefiles"

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          path: AdaptixC2
          ref: ${{ github.ref }}

      # ğŸ§ Linux: å®‰è£… Qt6 åŠå…¶ç»„ä»¶ (åŒ…å« declarative/QML å’Œ XKB)
      - name: Install dependencies (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake qt6-base-dev qt6-declarative-dev qt6-websockets-dev qt6-tools-dev libgl1-mesa-dev libxkbcommon-dev libxkbcommon-x11-dev libxcb-xkb-dev libxcb-icccm4-dev libxcb-image0-dev libxcb-keysyms1-dev libxcb-randr0-dev libxcb-render-util0-dev libxcb-render0-dev libxcb-shape0-dev libxcb-sync-dev libxcb-xfixes0-dev libxcb-xinerama0-dev libxcb-xkb-dev x11-xserver-utils

      # ğŸªŸ Windows: å®‰è£… Qt å’Œ MinGW å·¥å…·é“¾
      - name: Install Qt (Windows)
        if: matrix.os == 'windows-latest'
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.5.3'
          host: 'windows'
          target: 'desktop'
          arch: 'win64_mingw'
          dir: '${{ github.workspace }}/qt/'
          install-deps: 'true'
          modules: 'qtwebsockets'
          tools: 'tools_mingw' # å¿…é¡»å®‰è£…ï¼Œå¦åˆ™æ²¡æœ‰ gcc

      # ğŸªŸ Windows: ç§»é™¤ç³»ç»Ÿè‡ªå¸¦çš„ MinGWï¼Œé¿å…ä¸ Qt çš„ MinGW å†²çª
      - name: Sanitize Windows Environment
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          if (Test-Path "C:\mingw64") {
            Rename-Item -Path "C:\mingw64" -NewName "C:\mingw64_disabled"
            Write-Host "Disabled system MinGW at C:\mingw64 to avoid conflicts."
          }
          Write-Host "Checking gcc path:"
          Get-Command gcc | Select-Object -ExpandProperty Source

      - name: Configure CMake
        shell: bash
        run: |
          cd AdaptixC2/AdaptixClient
          
          if [ "${{ matrix.os_name }}" == "windows" ]; then
             # Windows: æŒ‡å®š MinGW ç”Ÿæˆå™¨
             cmake -B build -G "${{ matrix.cmake_gen }}" \
                   -DCMAKE_BUILD_TYPE=Release \
                   -DCMAKE_MAKE_PROGRAM="mingw32-make"
          else
             # Linux
             cmake -B build -G "${{ matrix.cmake_gen }}" -DCMAKE_BUILD_TYPE=Release
          fi

      - name: Build AdaptixClient
        run: |
          cd AdaptixC2/AdaptixClient
          cmake --build build --config Release --parallel

      # ğŸ“¦ æ‰“åŒ…é€»è¾‘ (Linux)
      - name: Prepare release package (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          cd AdaptixC2/AdaptixClient
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
          else
            VERSION="latest"
          fi
          
          mkdir -p release-package
          # ç›´æ¥æ‹·è´äºŒè¿›åˆ¶æ–‡ä»¶
          cp build/AdaptixClient release-package/ 2>/dev/null || true
          
          tar -czf AdaptixClient-${{ matrix.os_name }}-${VERSION}.tar.gz -C release-package .
          zip -r AdaptixClient-${{ matrix.os_name }}-${VERSION}.zip release-package/*

      # ğŸ“¦ æ‰“åŒ…é€»è¾‘ (Windows)
      - name: Prepare release package (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          cd AdaptixC2/AdaptixClient
          $VERSION = "latest"
          if ("${{ github.ref }}" -match "refs/tags/") {
            $VERSION = "${{ github.ref }}" -replace "refs/tags/", ""
          }
          
          New-Item -ItemType Directory -Force -Path release-package
          
          $exePath = "build/AdaptixClient.exe"
          if (-not (Test-Path $exePath)) { $exePath = "build/Release/AdaptixClient.exe" }
          
          if (Test-Path $exePath) {
            Copy-Item $exePath "release-package/"
            # è‡ªåŠ¨éƒ¨ç½² Qt ä¾èµ– DLL
            windeployqt --release --no-translations --no-system-d3d-compiler "release-package/AdaptixClient.exe"
            
            Compress-Archive -Path "release-package/*" -DestinationPath "AdaptixClient-windows-${VERSION}.zip"
          } else {
            Write-Warning "AdaptixClient.exe not found, skipping packaging."
          }

      - name: Upload release archives
        uses: actions/upload-artifact@v4
        with:
          name: release-archives-${{ matrix.os_name }}
          path: |
            AdaptixC2/AdaptixClient/*.tar.gz
            AdaptixC2/AdaptixClient/*.zip
          if-no-files-found: warn

  create-release:
    needs: build
    if: startsWith(github.ref, 'refs/tags/v') || (github.event_name == 'workflow_dispatch' && github.event.inputs.create_release == 'true')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: release-archives-*
          merge-multiple: true

      - name: Prepare release files
        run: |
          mkdir -p release_final
          cp artifacts/* release_final/
          
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
          else
            VERSION="latest"
          fi
          echo "VERSION=${VERSION}" >> $GITHUB_ENV

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: release_final/*
          tag_name: ${{ env.VERSION }}
          name: AdaptixClient Release ${{ env.VERSION }}
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ## AdaptixClient Release ${{ env.VERSION }}
            
            ### ğŸ“¥ ä¸‹è½½åˆ—è¡¨
            | å¹³å° | æ–‡ä»¶ | è¯´æ˜ |
            |---|---|---|
            | ğŸ§ Linux | `AdaptixClient-linux-${{ env.VERSION }}.tar.gz` | éœ€è¦å®‰è£… Qt6 |
            | ğŸªŸ Windows | `AdaptixClient-windows-${{ env.VERSION }}.zip` | è§£å‹å³ç”¨ (å«ä¾èµ–) |
            
            ### æ ¡éªŒå’Œ
            æ„å»º SHA: ${{ github.sha }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
