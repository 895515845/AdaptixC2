name: Build AdaptixServer with Extenders and Create Release

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create a GitHub Release'
        required: false
        default: 'false'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          path: AdaptixC2
          repository: 895515845/AdaptixC2
          ref: ${{ github.ref }}

      - name: Set up environment
        run: |
          sudo apt-get update
          sudo apt-get install -y mingw-w64 make gcc g++ g++-mingw-w64 wget git

      - name: Install specific Go version (1.25.4)
        run: |
          wget https://go.dev/dl/go1.25.4.linux-amd64.tar.gz -O /tmp/go.tar.gz
          sudo rm -rf /usr/local/go
          sudo tar -C /usr/local -xzf /tmp/go.tar.gz
          echo "/usr/local/go/bin" >> $GITHUB_PATH

      - name: Clone patched Go for Windows 7 support (gopher agent)
        run: |
          git clone https://github.com/Adaptix-Framework/go-win7 /tmp/go-win7
          sudo mv /tmp/go-win7 /usr/lib/go-win7

      - name: Build server and extenders (equivalent to make server-ext)
        run: |
          cd AdaptixC2
          make server-ext
          make extenders || make all || make

      - name: Create release archive
        run: |
          cd AdaptixC2
          VERSION=${GITHUB_REF#refs/tags/}
          if [ "$VERSION" == "$GITHUB_REF" ]; then
            VERSION="latest"
          fi
          RELEASE_NAME="AdaptixServer-${VERSION}"
          echo "RELEASE_NAME=${RELEASE_NAME}" >> $GITHUB_ENV
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          
          mkdir -p release-package
          cp -r dist/* release-package/
          
          tar -czf ${RELEASE_NAME}.tar.gz -C release-package .
          zip -r ${RELEASE_NAME}.zip release-package/*

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: adaptixserver-and-extenders
          path: |
            AdaptixC2/dist/adaptixserver
            AdaptixC2/dist/extenders/
            AdaptixC2/dist/*.json
            AdaptixC2/dist/ssl_gen.sh
            AdaptixC2/dist/404page.html
          if-no-files-found: warn

      - name: Upload release archives
        uses: actions/upload-artifact@v4
        with:
          name: release-archives
          path: |
            AdaptixC2/*.tar.gz
            AdaptixC2/*.zip
          if-no-files-found: warn

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/v') || github.event.inputs.create_release == 'true'
        uses: softprops/action-gh-release@v1
        with:
          files: |
            AdaptixC2/*.tar.gz
            AdaptixC2/*.zip
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ## AdaptixC2 Server Release ${{ env.VERSION }}
            
            ### 构建产物
            - `AdaptixServer-${{ env.VERSION }}.tar.gz` - Linux服务器和扩展器（压缩包）
            - `AdaptixServer-${{ env.VERSION }}.zip` - Linux服务器和扩展器（ZIP格式）
            
            ### 包含内容
            - adaptixserver - 主服务器二进制文件
            - extenders/ - 所有扩展器插件
            - profile.json - 服务器配置文件
            - ssl_gen.sh - SSL证书生成脚本
            - 404page.html - 自定义404页面
            
            ### 安装说明
            1. 下载并解压压缩包
            2. 配置 profile.json
            3. 运行 `./ssl_gen.sh` 生成SSL证书
            4. 启动服务器：`./adaptixserver`
            
            ### 系统要求
            - Linux x86_64
            - Go 1.25.4 (用于编译扩展器)
            - 适用于Windows 7的Go补丁版本 (用于Gopher代理)
            
            ### 文档
            完整文档请访问：https://adaptix-framework.gitbook.io/adaptix-framework
            
            ### 许可证
            本工具专为授权安全测试和红队操作设计。未经授权的使用严格禁止。
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
