name: Build All and Release

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create a GitHub Release'
        required: false
        default: 'true'

permissions:
  contents: write

jobs:
  # ========================================================
  # 1. 构建 Server (Linux)
  # ========================================================
  build-server:
    name: Build Server (Linux)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          path: AdaptixC2

      - name: Set up environment
        run: |
          sudo apt-get update
          sudo apt-get install -y mingw-w64 make gcc g++ g++-mingw-w64 wget git

      # 修正：Go 1.25 尚未发布，改为当前最新的稳定版 1.23.4 以防 404
      - name: Install Go
        run: |
          wget https://go.dev/dl/go1.23.4.linux-amd64.tar.gz -O /tmp/go.tar.gz
          sudo rm -rf /usr/local/go
          sudo tar -C /usr/local -xzf /tmp/go.tar.gz
          echo "/usr/local/go/bin" >> $GITHUB_PATH

      - name: Clone patched Go (Windows 7 support)
        run: |
          git clone https://github.com/Adaptix-Framework/go-win7 /tmp/go-win7
          sudo mv /tmp/go-win7 /usr/lib/go-win7

      - name: Build server and extenders
        run: |
          cd AdaptixC2
          make server-ext
          make extenders || make all || make

      - name: Package Server
        run: |
          cd AdaptixC2
          # 确定版本号
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
          else
            VERSION="latest"
          fi
          
          mkdir -p release-package-server
          cp -r dist/* release-package-server/
          
          tar -czf AdaptixServer-${VERSION}.tar.gz -C release-package-server .
          zip -r AdaptixServer-${VERSION}.zip release-package-server/*

      - name: Upload Server Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: artifact-server
          path: |
            AdaptixC2/*.tar.gz
            AdaptixC2/*.zip

  # ========================================================
  # 2. 构建 Client (Linux)
  # ========================================================
  build-client-linux:
    name: Build Client (Linux)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          path: AdaptixC2

      # 使用系统源安装 Qt 6 (最稳妥的 Linux 方案)
      - name: Install Qt6 Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y software-properties-common
          sudo add-apt-repository universe -y
          sudo apt-get update
          sudo apt-get install -y \
            build-essential cmake zip \
            qt6-base-dev qt6-base-private-dev \
            qt6-websockets-dev qt6-declarative-dev \
            libgl1-mesa-dev libvulkan1 \
            libxkbcommon-dev libxkbcommon-x11-dev \
            libxcb-*

      - name: Configure CMake
        run: |
          cd AdaptixC2/AdaptixClient
          cmake -B build -G "Unix Makefiles" \
                -DCMAKE_BUILD_TYPE=Release \
                -DCMAKE_CXX_FLAGS_RELEASE="-O2 -DNDEBUG" \
                -DCMAKE_C_FLAGS_RELEASE="-O2 -DNDEBUG"

      - name: Build
        run: |
          cd AdaptixC2/AdaptixClient
          cmake --build build --config Release --parallel $(nproc)

      - name: Package Linux Client
        run: |
          cd AdaptixC2/AdaptixClient
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
          else
            VERSION="latest"
          fi
          
          mkdir -p release-package-linux
          cp build/AdaptixClient release-package-linux/
          
          tar -czf AdaptixClient-linux-${VERSION}.tar.gz -C release-package-linux .
          zip -r AdaptixClient-linux-${VERSION}.zip release-package-linux/*

      - name: Upload Linux Client Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: artifact-client-linux
          path: |
            AdaptixC2/AdaptixClient/*.tar.gz
            AdaptixC2/AdaptixClient/*.zip

  # ========================================================
  # 3. 构建 Client (Windows)
  # ========================================================
  build-client-windows:
    name: Build Client (Windows)
    runs-on: windows-2022
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          path: AdaptixC2
          submodules: recursive

      - name: Install Ninja
        run: choco install ninja --version=1.12.1 --force

      - name: Install CMake
        uses: lukka/get-cmake@v3.30.5

      # 使用你确认可用的 Qt 6.9.1 (注意：如果是预览版可能不稳定，如下载失败请降级到 6.8.0)
      - name: Install Qt MinGW
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.9.1'
          host: 'windows'
          target: 'desktop'
          arch: 'win64_mingw'
          modules: 'qtwebsockets'
          tools: 'tools_opensslv3_x64'
          cache: 'true'

      - name: Configure CMake
        run: |
          cd AdaptixC2/AdaptixClient
          cmake -B build -G "Ninja" -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: |
          cd AdaptixC2/AdaptixClient
          cmake --build build --config Release

      - name: Package Windows Client
        shell: pwsh
        run: |
          cd AdaptixC2/AdaptixClient
          
          # 确定版本
          $VERSION = "latest"
          if ("${{ github.ref }}" -match "refs/tags/") {
            $VERSION = "${{ github.ref }}" -replace "refs/tags/", ""
          }

          # 寻找 EXE
          $exe = Get-ChildItem -Path build -Recurse -Include AdaptixClient.exe | Select-Object -First 1
          if (!$exe) { throw "AdaptixClient.exe not found" }
          
          # 创建打包目录
          mkdir portable_adaptixclient
          Copy-Item $exe.FullName portable_adaptixclient/
          
          # 部署依赖 (windeployqt)
          windeployqt --release portable_adaptixclient/AdaptixClient.exe
          
          # 压缩
          Compress-Archive -Path portable_adaptixclient/* -DestinationPath "AdaptixClient-windows-${VERSION}.zip"

      - name: Upload Windows Client Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: artifact-client-windows
          path: AdaptixC2/AdaptixClient/*.zip

  # ========================================================
  # 4. 发布 Release (汇总所有产物)
  # ========================================================
  release:
    name: Create Release
    needs: [build-server, build-client-linux, build-client-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v') || (github.event_name == 'workflow_dispatch' && github.event.inputs.create_release == 'true')
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 下载所有 Job 上传的产物到当前目录
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: all_artifacts
          pattern: artifact-*
          merge-multiple: true

      - name: List Files (Debug)
        run: ls -R all_artifacts

      - name: Determine Tag
        id: tag_logic
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
            echo "VERSION=$VERSION" >> $GITHUB_ENV
            echo "TAG_NAME=$VERSION" >> $GITHUB_ENV
          else
            echo "VERSION=latest" >> $GITHUB_ENV
            echo "TAG_NAME=latest" >> $GITHUB_ENV
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: all_artifacts/*
          tag_name: ${{ env.TAG_NAME }}
          name: Adaptix Release ${{ env.VERSION }}
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ## Adaptix Release ${{ env.VERSION }}
            
            自动构建产物汇总：
            
            ### 🖥️ Server (Linux)
            - `AdaptixServer-${{ env.VERSION }}.tar.gz`
            - `AdaptixServer-${{ env.VERSION }}.zip`
            
            ### 💻 Client (Linux)
            - `AdaptixClient-linux-${{ env.VERSION }}.tar.gz`
            - `AdaptixClient-linux-${{ env.VERSION }}.zip`
            
            ### 🪟 Client (Windows)
            - `AdaptixClient-windows-${{ env.VERSION }}.zip` (Portable, 解压即用)
            
            > **注意**: 如果这是手动构建，版本号将显示为 `latest`。
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
