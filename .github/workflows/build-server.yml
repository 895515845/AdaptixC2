name: Build AdaptixServer with Extenders and Create Release

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create a GitHub Release'
        required: false
        default: 'true'

# ğŸŸ¢ ä¿®æ”¹ 1ï¼šæ·»åŠ å†™æƒé™ï¼Œé˜²æ­¢ 403 é”™è¯¯
permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          path: AdaptixC2
          ref: ${{ github.ref }}

      - name: Set up environment
        run: |
          sudo apt-get update
          sudo apt-get install -y mingw-w64 make gcc g++ g++-mingw-w64 wget git

      - name: Install specific Go version (1.25.4)
        run: |
          wget https://go.dev/dl/go1.25.4.linux-amd64.tar.gz -O /tmp/go.tar.gz
          sudo rm -rf /usr/local/go
          sudo tar -C /usr/local -xzf /tmp/go.tar.gz
          echo "/usr/local/go/bin" >> $GITHUB_PATH

      - name: Clone patched Go for Windows 7 support (gopher agent)
        run: |
          git clone https://github.com/Adaptix-Framework/go-win7 /tmp/go-win7
          sudo mv /tmp/go-win7 /usr/lib/go-win7

      - name: Build server and extenders
        run: |
          cd AdaptixC2
          make server-ext
          make extenders || make all || make

      - name: Create release archive
        run: |
          cd AdaptixC2
          # é€»è¾‘æ£€æŸ¥ï¼š
          # å¦‚æœæ˜¯ tag è§¦å‘ï¼ŒVERSION å– tag å (å¦‚ v1.0)
          # å¦‚æœæ˜¯æ‰‹åŠ¨/mainåˆ†æ”¯è§¦å‘ï¼ŒVERSION å–åä¸º "latest"
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
          else
            VERSION="latest"
          fi
          
          RELEASE_NAME="AdaptixServer-${VERSION}"
          echo "RELEASE_NAME=${RELEASE_NAME}" >> $GITHUB_ENV
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          
          mkdir -p release-package
          cp -r dist/* release-package/
          
          tar -czf ${RELEASE_NAME}.tar.gz -C release-package .
          zip -r ${RELEASE_NAME}.zip release-package/*

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: adaptixserver-and-extenders
          path: |
            AdaptixC2/dist/adaptixserver
            AdaptixC2/dist/extenders/
            AdaptixC2/dist/*.json
            AdaptixC2/dist/ssl_gen.sh
            AdaptixC2/dist/404page.html
          if-no-files-found: warn

      - name: Upload release archives
        uses: actions/upload-artifact@v4
        with:
          name: release-archives
          path: |
            AdaptixC2/*.tar.gz
            AdaptixC2/*.zip
          if-no-files-found: warn

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/v') || (github.event_name == 'workflow_dispatch' && github.event.inputs.create_release == 'true')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            AdaptixC2/*.tar.gz
            AdaptixC2/*.zip
          # ğŸŸ¢ ä¿®æ”¹ 2ï¼šæ˜¾å¼æŒ‡å®š tag_name
          # å¦‚æœæ˜¯æ‰‹åŠ¨è§¦å‘ï¼Œè¿™é‡Œä¼šæ˜¯ "latest"ï¼Œæ’ä»¶ä¼šè‡ªåŠ¨åˆ›å»ºæˆ–æ›´æ–° latest æ ‡ç­¾
          tag_name: ${{ env.VERSION }}
          name: AdaptixC2 Server Release ${{ env.VERSION }}
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ## AdaptixC2 Server Release ${{ env.VERSION }}
            
            ### æ„å»ºäº§ç‰©
            - `AdaptixServer-${{ env.VERSION }}.tar.gz`
            - `AdaptixServer-${{ env.VERSION }}.zip`
            
            ### åŒ…å«å†…å®¹
            - adaptixserver - ä¸»æœåŠ¡å™¨äºŒè¿›åˆ¶æ–‡ä»¶
            - extenders/ - æ‰€æœ‰æ‰©å±•å™¨æ’ä»¶
            - profile.json - æœåŠ¡å™¨é…ç½®æ–‡ä»¶
            - ssl_gen.sh - SSLè¯ä¹¦ç”Ÿæˆè„šæœ¬
            - 404page.html - è‡ªå®šä¹‰404é¡µé¢
            
            ### å®‰è£…è¯´æ˜
            1. ä¸‹è½½å¹¶è§£å‹å‹ç¼©åŒ…
            2. é…ç½® profile.json
            3. è¿è¡Œ `./ssl_gen.sh` ç”ŸæˆSSLè¯ä¹¦
            4. å¯åŠ¨æœåŠ¡å™¨ï¼š`./adaptixserver`
            
            ### æ–‡æ¡£
            å®Œæ•´æ–‡æ¡£è¯·è®¿é—®ï¼šhttps://adaptix-framework.gitbook.io/adaptix-framework
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
